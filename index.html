<!DOCTYPE html>
<html>

  <head>
    <link rel="stylesheet" href="style.css">
    <script src='https://d3js.org/d3.v5.min.js'></script>
  </head>

  <body width=600 onload='init()'>
    <h1>CS 416 Narrative Visualization Project - Brian Hennessy</h1>
    <nav id='navBar'>
      <button class="button" id="previousButton" style="visibility:hidden" onclick="previous()">Previous</button>
      <button class="button" id="nextButton" onclick="next()">Next</button>
    </nav>
    <div id="visualization" align="left"></div>
    <div><p id="text"></p></div>
    <p><u>Sources</u><br>https://www.fueleconomy.gov/feg/download.shtml<br>https://www.ucsusa.org/resources/brief-history-us-fuel-efficiency<br>https://www.energy.gov/articles/history-electric-car</p>
    <div id="tooltip" align="left"></div>
    <script>


















// margin setup
var margin = {top: 50, right: 50, bottom: 100, left: 50},
  width = 600 - margin.left - margin.right
  height = 650 - margin.top - margin.bottom;

// svg setup
var svg = d3.select("#visualization").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// x-axis
var x = d3.scaleLinear().range([0,width]);
var xlog = d3.scaleLog().base(10).range([1,width]);
var xAxis = d3.axisBottom().scale(x);
svg.append("g")
  .attr("transform","translate(0," + height + ")")
  .attr("class","xaxis")
  .append("text")
  .attr("class","xlabel")
  .attr("fill","black")
  .attr("transform","translate(" + width/2 + ",40)")
  .attr("text-anchor", "middle")

// y-axis
var y = d3.scaleLinear().range([height,0]);
var ylog = d3.scaleLog().base(10).range([height,1]);
var yAxis = d3.axisLeft().scale(y);
svg.append("g")
  .attr("class","yaxis")
  .append("text")
  .attr("class","ylabel")
  .attr("fill","black")
  .attr("transform","rotate(-90)")
  .attr("x",-height/2)
  .attr("y",-margin.left)
  .attr("dy", "1em")
  .attr("text-anchor", "middle")

function text(slide) {
  if (slide == 0 ^ slide == 1) {
    document.getElementById("text").innerHTML = "In 1975, congress established the Corporate Average Fuel Economy (CAFE) standards in response to an oil embargo by OPEC 1973. The new standards went into effect starting with model year 1978 and were expected to roughly double fuel economy by 1985. No updates to the standards were made until 2009 when an agreement was reached between the federal government, state regulators, and the auto industry to establish a national program.<br><br>The first phase of this national program when into effect in 2012 and called for ~5% increase in fuel economy each year from 2012 to 2016. The second phase of the program started in 2017 and call for a decrease in average global warming emissions to 163 grams per mile. Some of this emissions limit is met by improvements to air conditioning systems, but it is expected that this phase will lead to a fuel economy increase to 36-37 MPG.";
  } else if (slide == 2) {
    document.getElementById("text").innerHTML = "Throughout the last decade, vehicles using alternative fuels have begun to become more prevalent. These alternative fuel vehicles have had a large contribution to the increase in the overall fuel economy. Plug-in hybrids, hydrogen fuel cell cars, and electric vehicles have made strides in improving the efficiency of transportation.<br><br>These technologies have become more prevalent and have led to lower overall global warming emissions and decreased fuel cost for consumers.<br><br>Note: For the purposes of this chart, hydrogen and electric vehicles have the energy used to power them converted into a MPG equivalent.";
  } else if (slide == 3) {
    document.getElementById("text").innerHTML = "Year displayed can be changed at the top of the chart. Hover over points to see detailed information about the individual vehicles.<br><br>This chart gives the relationship between fuel economy and annual fuel cost of the consumer. It shows how regulations that increase fuel economy standards also help consumers by reducing their fuel costs.";
  }
}

function title(slide) {
  if (slide == 0) {
    svg.append("text")
      .attr("class","title")
      .attr("transform","translate(" + width/2 + "," + -margin.top/2 + ")")
      .attr("text-anchor","middle")
      .text("Overall Fuel Economy");
  } else if (slide == 1) {
    svg.selectAll(".title")
      .text("Overall Fuel Economy");
  } else if (slide == 2) {
    svg.selectAll(".title")
      .text("Fuel Economy by Vehicle Type");
  } else if (slide == 3) {
    svg.selectAll(".title")
    .text("Annual Fuel Cost vs Fuel Economy");
  }
}

function axes(slide,carYear) {
  if (slide == 0 ^ slide == 1) {
    x.domain([d3.min(overall,function(d) { return parseInt(d.key) }),d3.max(overall,function(d) { return parseInt(d.key) })]);
    y.domain([0,slide1Max]);
    d3.selectAll(".xlabel").text("Model Year");
    d3.selectAll(".ylabel").text("Fuel Economy (MPG)");
  } else if (slide == 2) {
    x.domain([d3.min(overall,function(d) { return parseInt(d.key) }),d3.max(overall,function(d) { return parseInt(d.key) })]); 
    y.domain([0,slide2Max]);
    d3.selectAll(".xlabel").text("Model Year");
    d3.selectAll(".ylabel").text("Fuel Economy (MPG)");
  } else if (slide == 3) {
    xlog.domain([d3.min(data.filter(function(d) { if (d["ModelYear"] == carYear) { return d }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}),function(d) { return parseInt(d.CombFE) }),d3.max(data.filter(function(d) { if (d["ModelYear"] == carYear) { return d }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}),function(d) { return parseInt(d.CombFE) })]); 
    ylog.domain([d3.min(data.filter(function(d) { if (d["ModelYear"] == carYear) { return d }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}),function(d) { return parseInt(d.AnnualFuelCost) }),d3.max(data.filter(function(d) { if (d["ModelYear"] == carYear) { return d }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}),function(d) { return parseInt(d.AnnualFuelCost) })]);
    d3.selectAll(".xlabel").text("Fuel Economy (MPG)");
    d3.selectAll(".ylabel").text("Annual Fuel Cost ($/year)");
  }

  if (slide == 0) {
    svg.selectAll(".xaxis")
      .call(xAxis
        .ticks(7)
        .tickFormat(d3.format("~")));
    svg.selectAll(".yaxis")
      .call(yAxis
        .ticks(5)
        .tickFormat(d3.format("~s")));
  } else if (slide == 3) {
    svg.selectAll(".xaxis")
      .transition()
      .duration(3000)
      .call(d3.axisBottom().scale(xlog)
        .ticks(7)
        .tickFormat(d3.format("~")));
    svg.selectAll(".yaxis")
      .transition()
      .duration(3000)
      .call(d3.axisLeft().scale(ylog)
        .ticks(5)
        .tickFormat(d3.format("~s")));
  } else {
    svg.selectAll(".xaxis")
      .transition()
      .duration(3000)
      .call(xAxis
        .ticks(7)
        .tickFormat(d3.format("~")));
    svg.selectAll(".yaxis")
      .transition()
      .duration(3000)
      .call(yAxis
        .ticks(5)
        .tickFormat(d3.format("~s")));
  }
}

function legend(slide) {
  if (slide == 0 ^ slide == 1) {
    var legendData = 
      [{"offset": -50, "text": "Overall", "color": "steelblue"},
      {"offset": -50, "text": " ", "color": "steelblue"},
      {"offset": -50, "text": " ", "color": "steelblue"},
      {"offset": -50, "text": " ", "color": "steelblue"},
      {"offset": -50, "text": " ", "color": "steelblue"}];
  } else if (slide == 2) {
    var legendData = 
      [{"offset": -175, "text": "Overall", "color": "steelblue"},
      {"offset": -105, "text": "Gas", "color": "red"},
      {"offset": -50, "text": "Electric", "color": "blue"},
      {"offset": 20, "text": "Plug-In Hybrid", "color": "purple"},
      {"offset": 130, "text": "Fuel Cell", "color": "green"}];
  } else if (slide == 3) {
    var legendData = 
      [{"offset": -105, "text": " ", "color": "red"},
      {"offset": -105, "text": "Gas", "color": "red"},
      {"offset": -50, "text": "Electric", "color": "blue"},
      {"offset": 20, "text": "Plug-In Hybrid", "color": "purple"},
      {"offset": 130, "text": "Fuel Cell", "color": "green"}];
  }

  var legendMarks = svg.selectAll(".legendmark").data(legendData);
  var legendText = svg.selectAll(".legendtext").data(legendData);

  if (slide == 0) {
    legendMarks = legendMarks.enter().append("circle").attr("class","legendmark").merge(legendMarks);
    legendText = legendText.enter().append("text").attr("class","legendtext").merge(legendText);
  } else {
    legendMarks = legendMarks.enter().append("circle").attr("class","legendmark").merge(legendMarks).transition().duration(3000).style("opacity",100);
    legendText = legendText.enter().append("text").attr("class","legendtext").merge(legendText).transition().duration(3000).style("opacity",100);
  }

  legendMarks
    .attr("cx",function(d) { return d.offset + width/2; })
    .attr("cy",parseInt(height) + 80)
    .attr("r",6)
    .style("fill",function(d) { return d.color; });

  legendText
    .attr("x",function(d) { return d.offset + width/2 + 10; })
    .attr("y",parseInt(height) + 80)
    .attr("class","legendtext")
    .text(function(d) { return d.text; })
    .attr("alignment-baseline","middle");
}

function lines(slide) {
  if (slide == 0 ^ slide == 1) {
    var overallLine = svg.selectAll(".overallline").data([overall]);
    var gasLine = svg.selectAll(".gasline").data([overall]);
    var electricLine = svg.selectAll(".electricline").data([overall]);
    var plugInLine = svg.selectAll(".pluginline").data([overall]);
    var fuelCellLine = svg.selectAll(".fuelcellline").data([overall]);
  }
  else if (slide == 2) {
    var overallLine = svg.selectAll(".overallline").data([overall]);
    var gasLine = svg.selectAll(".gasline").data([gas]);
    var electricLine = svg.selectAll(".electricline").data([electric]);
    var plugInLine = svg.selectAll(".pluginline").data([plugIn]);
    var fuelCellLine = svg.selectAll(".fuelcellline").data([fuelCell]);
  }

  if (slide == 3) {
    svg.selectAll(".overallline").data([]).exit().transition().duration(1000).style("opacity",0).remove();
    svg.selectAll(".gasline").data([]).exit().transition().duration(1000).style("opacity",0).remove();
    svg.selectAll(".electricline").data([]).exit().transition().duration(1000).style("opacity",0).remove();
    svg.selectAll(".pluginline").data([]).exit().transition().duration(1000).style("opacity",0).remove();
    svg.selectAll(".fuelcellline").data([]).exit().transition().duration(1000).style("opacity",0).remove();
  } else {
    gasLine.enter().append("path").attr("class","gasline").merge(gasLine).transition().duration(3000).style("opacity",100)
      .attr("d",d3.line()
        .x(function(d) { return x(d.key); })
        .y(function(d) { return y(d.value.averageFE); })
        .curve(d3.curveMonotoneX));

    electricLine.enter().append("path").attr("class","electricline").merge(electricLine).transition().duration(3000).style("opacity",100)
      .attr("d",d3.line()
        .x(function(d) { return x(d.key); })
        .y(function(d) { return y(d.value.averageFE); })
        .curve(d3.curveMonotoneX));

    plugInLine.enter().append("path").attr("class","pluginline").merge(plugInLine).transition().duration(3000).style("opacity",100)
      .attr("d",d3.line()
        .x(function(d) { return x(d.key); })
        .y(function(d) { return y(d.value.averageFE); })
        .curve(d3.curveMonotoneX));

    fuelCellLine.enter().append("path").attr("class","fuelcellline").merge(fuelCellLine).transition().duration(3000).style("opacity",100)
      .attr("d",d3.line()
        .x(function(d) { return x(d.key); })
        .y(function(d) { return y(d.value.averageFE); })
        .curve(d3.curveMonotoneX));

    overallLine.enter().append("path").attr("class","overallline").merge(overallLine).transition().duration(3000).style("opacity",100)
      .attr("d",d3.line()
        .x(function(d) { return x(d.key); })
        .y(function(d) { return y(d.value.averageFE); })
        .curve(d3.curveMonotoneX));
  }
}

function cars(slide,carYear) {
  
  if (slide == 3) {
    var cars = svg.selectAll(".cars").data(data.filter(function(d) { if (d["ModelYear"] == carYear) { return d }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));
  } else {
    var cars = svg.selectAll(".cars").data([]);
  }

  var carCircles = cars.enter().append("circle").attr("class","cars").merge(cars);
  carCircles.transition().duration(3000).style("opacity",100)    
    .attr("cx",function(d) { return xlog(d.CombFE); })
    .attr("cy",function(d) { return ylog(d.AnnualFuelCost); })
    .attr("r",5)
    .style("fill", function(d) { if (d.Type == "Gas") { return "red" } else if (d.Type == "Electric") { return "blue" } else if (d.Type == "Plug-In") { return "purple" } else if (d.Type == "Fuel Cell") { return "green" }; });
  carCircles
    .on("mouseover",mouseover)
    .on("mousemove",mousemove)
    .on("mouseleave",mouseleave);
      
    cars.exit().transition().duration(1000).style("opacity",0).remove();
}

function annotation(slide) {
  if (slide == 0) {
    var annotations = 
      [{"x1": 2010, "y1": 16, "x2": 2011, "y2": 15, "text": "Congress estabilishes Corporate Average Fuel Economy standards in 1975."},
      {"x1": 2010, "y1": 20, "x2": 2010.5, "y2": 17, "text": "Agreement reached to estabilsh national program to implement first fuel efficency improvements in 34 years in 2009."},
      {"x1": 2012, "y1": overall.filter(function(d) { return d.key === "2012" })[0].value.averageFE, "x2": 2011, "y2": 19.5, "text": "First phase of national program goes into effect calling for an annual ~5% increase in fuel economy from 2012 to 2016."},
      {"x1": 2017, "y1": overall.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2012.5, "y2": 21.5, "text": "Second phase of nation program goes into effect. Fuel efficiency expected to increase to 36-37 mpg by 2025."}];
  } else if (slide == 1) {
    var annotations = 
      [{"x1": 2010, "y1": 16, "x2": 2011, "y2": 15, "text": "Congress estabilishes Corporate Average Fuel Economy standards in 1975."},
      {"x1": 2010, "y1": 20, "x2": 2010.5, "y2": 17, "text": "Agreement reached to estabilsh national program to implement first fuel efficency improvements in 34 years in 2009."},
      {"x1": 2012, "y1": overall.filter(function(d) { return d.key === "2012" })[0].value.averageFE, "x2": 2011, "y2": 19.5, "text": "First phase of national program goes into effect calling for an annual ~5% increase in fuel economy from 2012 to 2016."},
      {"x1": 2017, "y1": overall.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2012.5, "y2": 21.5, "text": "Second phase of nation program goes into effect. Fuel efficiency expected to increase to 36-37 mpg by 2025."}];
  } else if (slide == 2) {
    var annotations = 
      [{"x1": 2017, "y1": electric.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2016.5, "y2": 95, "text": "The best selling electric vehicle, the Tesla Model 3, is released."},
      {"x1": 2013, "y1": electric.filter(function(d) { return d.key === "2013" })[0].value.averageFE, "x2": 2013.5, "y2": 80, "text": "Nissan begins assembling the Leaf, the first zero tailpipe emissions mass market vehicle."},
      {"x1": 2012, "y1": overall.filter(function(d) { return d.key === "2012" })[0].value.averageFE, "x2": 2011, "y2": 10, "text": "First phase of national program goes into effect calling for an annual ~5% increase in fuel economy from 2012 to 2016."},
      {"x1": 2017, "y1": overall.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2012.5, "y2": 15, "text": "Second phase of nation program goes into effect. Fuel efficiency expected to increase to 36-37 mpg by 2025."}];
  } else if (slide == 3) {
    var annotations = []
  }
  
  var annotationLine = svg.selectAll(".annotationline").data(annotations);
  var annotationText = svg.selectAll(".annotationtext").data(annotations);

  if (slide == 0) {
    annotationLine = annotationLine.enter().append("line").attr("class","annotationline").merge(annotationLine);
    annotationText = annotationText.enter().append("text").attr("class","annotationtext").merge(annotationText);
  } else {
    annotationLine.exit().transition().duration(1000).style("opacity",0).remove();
    annotationText.exit().transition().duration(1000).style("opactiy",0).remove();
    annotationLine = annotationLine.enter().append("line").attr("class","annotationline").merge(annotationLine).transition().duration(3000).style("opacity",100);
    annotationText = annotationText.enter().append("text").attr("class","annotationtext").merge(annotationText).transition().duration(3000).style("opacity",100);
  }

  annotationLine
    .attr("x1",function(d) { return x(d.x1) })
    .attr("y1",function(d) { return y(d.y1) })
    .attr("x2",function(d) { return x(d.x2) })
    .attr("y2",function(d) { return y(d.y2) });

  annotationText
    .attr("x",function(d) { return x(d.x2) })
    .attr("y",function(d) { return y(d.y2) + 7 })
    .attr("text-anchor","start")
    .text(function(d) { return d.text });
}

function update(slide) {
  text(slide);
  title(slide);
  axes(slide,defaultYear);
  legend(slide);
  lines(slide);
  cars(slide,defaultYear);
  annotation(slide);
}

async function init() {
  // load data
  data = await d3.csv("https://raw.githubusercontent.com/bphennessy/CS416NarrativeVisualization/main/cars.csv")

  overall = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));

  gas = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Gas") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));

  electric = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Electric") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));
  
  plugIn = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Plug-In") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));

  fuelCell = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Fuel Cell") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));
  
  // set y max for each slide
  slide1Max = d3.max(overall,function(d) { return parseInt(d.value.averageFE) })

  slide2Max = Math.max(d3.max(gas,function(d) { return parseInt(d.value.averageFE) }),
    Math.max(d3.max(electric,function(d) { return parseInt(d.value.averageFE) }),
    Math.max(d3.max(plugIn,function(d) { return d.value.averageFE }), d3.max(fuelCell,function(d) { return parseInt(d.value.averageFE) }))));
  
  // initialize slides
  defaultYear = "2021"
  slide = 0;
  update(slide);
  slide = 1;
  dropdownsetup();
}

function previous() {
  if (slide != 1) {
    document.getElementById("nextButton").style.visibility = "visible";
    slide--
    update(slide)
  }
  if (slide == 1) {
    document.getElementById("previousButton").style.visibility = "hidden";
  } else {
    document.getElementById("previousButton").style.visibility = "visible";
    document.getElementById("carDropdown").style.visibility = "hidden";
  }
  dropdownOptions.property("selected", function(d) { return d.key === defaultYear; });
 }

function next() {
  if (slide != 3) {
    document.getElementById("previousButton").style.visibility = "visible";
    slide++
    update(slide)
  }
  if (slide == 3) {
    document.getElementById("nextButton").style.visibility = "hidden";
    document.getElementById("carDropdown").style.visibility = "visible";
  } else {
    document.getElementById("nextButton").style.visibility = "visible";
  }
}

// Handler for dropdown value change
function dropdownChange() {
  var newYear = d3.select(this).property('value');
  axes(slide,newYear);
  cars(slide,newYear);
};

var dropdown = d3.select("#navBar").insert("select", "svg")
  .attr("class","dropdown")
  .attr("id","carDropdown")
  .style("visibility","hidden")
  .on("change", dropdownChange);  

function dropdownsetup() {
  dropdownOptions = dropdown.selectAll("option").data(overall).enter().append("option")
  dropdownOptions
    .attr("value",function(d) { return d.key; })
    .text(function(d) { return d.key })
    .property("selected", function(d) { return d.key === defaultYear; });
}






  // Add a tooltip div. Here I define the general feature of the tooltip: stuff that do not depend on the data point.
  // Its opacity is set to 0: we don't see it by default.
  var tooltip = d3.select("#tooltip")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "1px")
    .style("border-radius", "5px")
    .style("padding", "10px")



  // A function that change this tooltip when the user hover a point.
  // Its opacity is set to 1: we can now see it. Plus it set the text and position of tooltip depending on the datapoint (d)
  var mouseover = function(d) {
    tooltip
      .style("opacity", 1)
  }

  var mousemove = function(d) {
    if (d.MaxEthanol != "") { var EtOH = d.MaxEthanol } else if (d.Type == "Gas") { var EtOH = "Not Reported" } else { var EtOH = "N/A" }
    if (d.Cylinders != "") { var cylinders = d.Cylinders } else { var cylinders = "N/A"}
    tooltip
      //.style("left", (d3.event.pageX/* + 16*/) + "px")
      //.style("top", (d3.event.pageY/* + 16*/) + "px")
      .style("left", (d3.mouse(this)[0]+60) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
      .style("top", (d3.mouse(this)[1]-816) + "px")
      .html("Make: " + d.Make + "<br>" +
        "Model: " + d.Model + "<br>" +
        "Cyliners: " + cylinders + "<br>" +
        "City Fuel Economy: " + d.CityFE + " MPG<br>" +
        "Highway Fuel Economy: " + d.HwyFE + " MPG<br>" +
        "Combined Fuel Economy: " + d.CombFE + " MPG<br>" +
        "Transmission: " + d.Trans + "<br>" +
        "Gears: " + d.Gears + "<br>" +
        "Drive: " + d.Drive + "<br>" +
        "Maximum Ethanol Content: " + EtOH + "<br>" +
        "Annual Fuel Cost: " + d.AnnualFuelCost + "<br>");
  }

  // A function that change this tooltip when the leaves a point: just need to set opacity to 0 again
  var mouseleave = function(d) {
    tooltip
      .transition()
      .duration(200)
      .style("opacity", 0)
  }








    </script>
    <!--<script src="script.js"></script>-->
  </body>

</html>