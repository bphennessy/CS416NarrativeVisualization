<!DOCTYPE html>
<html>

  <head>
    <link rel="stylesheet" href="style.css">
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
  </head>

  <body onload='init()'>
    <h1>CS 416 Narrative Visualization Project - Brian Hennessy</h1>
    <nav>
      <button class="button" onclick="previous()">Previous</button>
      <button class="button" onclick="next()">Next</button>
    </nav>
    <script>









function previous() {
  if (slide != 1) {
    slide--
    update(slide)
  }
 }

function next() {
  if (slide != 3) {
    slide++
    update(slide)
  }
}

// margin setup
var margin = {top: 50, right: 50, bottom: 150, left: 50},
  width = 600 - margin.left - margin.right
  height = 700 - margin.top - margin.bottom;

// svg setup
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// x-axis
var x = d3.scaleLinear().range([0,width]);
var xAxis = d3.axisBottom().scale(x);
svg.append("g")
  .attr("transform","translate(0," + height + ")")
  .attr("class","xaxis")
  .append("text")
  .attr("class","xlabel")
  .attr("fill","black")
  .attr("transform","translate(" + width/2 + ",40)")
  .attr("text-anchor", "middle")
  .text("Model Year");

// y-axis
var y = d3.scaleLinear().range([height,0]);
var yAxis = d3.axisLeft().scale(y);
svg.append("g")
  .attr("class","yaxis")
  .append("text")
  .attr("class","ylabel")
  .attr("fill","black")
  .attr("transform","rotate(-90)")
  .attr("x",-height/2)
  .attr("y",-margin.left)
  .attr("dy", "1em")
  .attr("text-anchor", "middle")
  .text("Fuel Efficiency (MPG)");

// legend
legendOffset = [-175, -105, -50, 20, 130];
legendText = ["Overall","Gas","Electric","Plug-In Hybrid","Fuel Cell"];
legendColor = ["steelblue","red","blue","purple","green"];
svg.selectAll(".legendmarks").data(legendOffset).enter().append("circle")
  .attr("cx", function(d) { return d+width/2; })
  .attr("cy", parseInt(height) + 80)
  .attr("r", 6)
  .style("fill", function(d,i) { return legendColor[i]; });
svg.selectAll(".legendtext").data(legendOffset).enter().append("text")
  .attr("x", function(d) { return d + width/2 + 10; })
  .attr("y",parseInt(height) + 80)
  .attr("class","legend")
  .text(function(d,i) { return legendText[i]; })
  .attr("alignment-baseline","middle");

function title(slide) {
  if (slide == 0) {
    svg.append("text")
      .attr("class","title")
      .attr("transform","translate(" + width/2 + "," + -margin.top/2 + ")")
      .attr("text-anchor","middle")
      .text("Overall Fuel Efficiency");
  } else if (slide == 1) {
    svg.selectAll(".title")
      .text("Overall Fuel Efficiency");
  } else if (slide == 2) {
    svg.selectAll(".title")
      .text("Fuel Efficiency by Vehicle Type");
  } else if (slide == 3) {
    svg.selectAll(".title")
    .text("Slide 3");
  }
}

function axes(slide) {
  if (slide == 0) {
    x.domain([d3.min(overall,function(d) { return d.key }),d3.max(overall,function(d) { return d.key })]);
    y.domain([0,d3.max(overall,function(d) { return d.value.averageFE })]);
  } else if (slide == 1) {
    x.domain([d3.min(overall,function(d) { return d.key }),d3.max(overall,function(d) { return d.key })]);
    y.domain([0,slide1Max]);
  } else if (slide == 2) {
    x.domain([d3.min(overall,function(d) { return d.key }),d3.max(overall,function(d) { return d.key })]); 
    y.domain([0,slide2Max]);
  }

  if (slide == 0) {
    svg.selectAll(".xaxis")
      .call(xAxis
        .ticks(7)
        .tickFormat(d3.format("~")));
    svg.selectAll(".yaxis")
      .call(yAxis
        .ticks(5)
        .tickFormat(d3.format("~s")));
  } else {
    svg.selectAll(".xaxis")
      .transition()
      .duration(3000);
    svg.selectAll(".yaxis")
      .transition()
      .duration(3000);
  }
}

function annotation(slide) {
  if (slide == 0) {
    var annotations = 
      [{"x1": 2010, "y1": 16, "x2": 2011, "y2": 15, "text": "Congress estabilishes Corporate Average Fuel Economy (CAFE) standards in 1975."},
      {"x1": 2010, "y1": 20, "x2": 2010.5, "y2": 17, "text": "Agreement reached to estabilsh national program to implement first fuel efficency improvements in 34 years in 2009."},
      {"x1": 2012, "y1": overall.filter(function(d) { return d.key === "2012" })[0].value.averageFE, "x2": 2011, "y2": 19.5, "text": "First phase of national program goes into effect calling for an annual ~5% increase in fuel economy from 2012 to 2016."},
      {"x1": 2017, "y1": overall.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2012.5, "y2": 21.5, "text": "Second phase of nation program goes into effect. Fuel efficiency expected to increase to 36-37 mpg by 2025."}];
  } else if (slide == 1) {
    var annotations = 
      [{"x1": 2010, "y1": 16, "x2": 2011, "y2": 15, "text": "Congress estabilishes Corporate Average Fuel Economy (CAFE) standards in 1975."},
      {"x1": 2010, "y1": 20, "x2": 2010.5, "y2": 17, "text": "Agreement reached to estabilsh national program to implement first fuel efficency improvements in 34 years in 2009."},
      {"x1": 2012, "y1": overall.filter(function(d) { return d.key === "2012" })[0].value.averageFE, "x2": 2011, "y2": 19.5, "text": "First phase of national program goes into effect calling for an annual ~5% increase in fuel economy from 2012 to 2016."},
      {"x1": 2017, "y1": overall.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2012.5, "y2": 21.5, "text": "Second phase of nation program goes into effect. Fuel efficiency expected to increase to 36-37 mpg by 2025."}];
  } else if (slide == 2) {
    var annotations = 
      [{"x1": 2017, "y1": electric.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2016.5, "y2": 95, "text": "The best selling electric vehicle, the Tesla Model 3, is released."},
      {"x1": 2013, "y1": electric.filter(function(d) { return d.key === "2013" })[0].value.averageFE, "x2": 2013.5, "y2": 80, "text": "Nissan begins assembling the Leaf, the first zero tailpipe emissions mass market vehicle."},
      {"x1": 2012, "y1": overall.filter(function(d) { return d.key === "2012" })[0].value.averageFE, "x2": 2011, "y2": 10, "text": "First phase of national program goes into effect calling for an annual ~5% increase in fuel economy from 2012 to 2016."},
      {"x1": 2017, "y1": overall.filter(function(d) { return d.key === "2017" })[0].value.averageFE, "x2": 2012.5, "y2": 15, "text": "Second phase of nation program goes into effect. Fuel efficiency expected to increase to 36-37 mpg by 2025."}];
  } else if (slide == 3) {
    var annotations = []
  }
  
  var annotationLine = svg.selectAll(".annotationline").data(annotations);
  var annotationText = svg.selectAll(".annotationtext").data(annotations);

  if (slide == 0) {
    annotationLine = annotationLine.enter().append("line").attr("class","annotationline").merge(annotationLine)
    annotationText = annotationText.enter().append("text").attr("class","annotationtext").merge(annotationText)
  } else {
    removeLine = annotationLine.exit().transition().duration(3000).style("opacity",0).remove()
    removeText = annotationText.exit().transition().duration(3000).style("opactiy",0).remove()
    annotationLine = annotationLine.enter().append("line").attr("class","annotationline").merge(annotationLine).transition().duration(3000).style("opacity",100)
    annotationText = annotationText.enter().append("text").attr("class","annotationtext").merge(annotationText).transition().duration(3000).style("opacity",100)
  }
  annotationLine
    .attr("x1",function(d) { return x(d.x1) })
    .attr("y1",function(d) { return y(d.y1) })
    .attr("x2",function(d) { return x(d.x2) })
    .attr("y2",function(d) { return y(d.y2) });

  annotationText
    .attr("x",function(d) { return x(d.x2) })
    .attr("y",function(d) { return y(d.y2) + 7 })
    .attr("text-anchor","start")
    .text(function(d) { return d.text });
}

function lines(slide) {
  if (slide == 0 ^ slide == 1) {
    var overallLine = svg.selectAll(".line").data([overall]);
    var gasLine = svg.selectAll(".gasline").data([overall]);
    var electricLine = svg.selectAll(".electricline").data([overall]);
    var plugInLine = svg.selectAll(".pluginline").data([overall]);
    var fuelCellLine = svg.selectAll(".fuelcellline").data([overall]);
  }
  else if (slide == 2) {
    var overallLine = svg.selectAll(".line").data([overall]);
    var gasLine = svg.selectAll(".gasline").data([gas]);
    var electricLine = svg.selectAll(".electricline").data([electric]);
    var plugInLine = svg.selectAll(".pluginline").data([plugIn]);
    var fuelCellLine = svg.selectAll(".fuelcellline").data([fuelCell]);
  }

  gasLine.enter().append("path").attr("class","gasline").merge(gasLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  electricLine.enter().append("path").attr("class","electricline").merge(electricLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  plugInLine.enter().append("path").attr("class","pluginline").merge(plugInLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  fuelCellLine.enter().append("path").attr("class","fuelcellline").merge(fuelCellLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  overallLine.enter().append("path").attr("class","line").merge(overallLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));
}

function update(slide) {
  title(slide);
  axes(slide);
  /*if (slide == 0) { slide1() }
  else if (slide == 1) { slide1() }
  else if (slide == 2) { slide2() }
  */else if (slide == 3) { slide3() }
  annotation(slide)
}

async function init() {
  // load data
  data = await d3.csv("https://raw.githubusercontent.com/bphennessy/CS416NarrativeVisualization/main/cars.csv")

  overall = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));

  gas = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Gas") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));

  electric = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Electric") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));
  
  plugIn = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Plug-In") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));

  fuelCell = d3.nest()
    .key(function(d) { return d.ModelYear; })
    .rollup(function(v) { return {"averageFE": d3.mean(v,function(d) { return d.CombFE; })}})
    .entries(data.filter(function(d) { if (d["Type"] == "Fuel Cell") { return d; }}).filter(function(d) { if (d["FuelUnit"] == "MPG") { return d; }}));
  
  // set y max for each slide
  slide1Max = d3.max(overall,function(d) { return d.value.averageFE })

  slide2Max = Math.max(d3.max(gas,function(d) { return d.value.averageFE }),
    Math.max(d3.max(electric,function(d) { return d.value.averageFE }),
    Math.max(d3.max(plugIn,function(d) { return d.value.averageFE }), d3.max(fuelCell,function(d) { return d.value.averageFE }))));
  
  // initialize slides
  slide = 0;
  update(slide);
  slide = 1;
}

/*function slide1() {
  // lines
  var overallLine = svg.selectAll(".line").data([overall]);
  var gasLine = svg.selectAll(".gasline").data([overall]);
  var electricLine = svg.selectAll(".electricline").data([overall]);
  var plugInLine = svg.selectAll(".pluginline").data([overall]);
  var fuelCellLine = svg.selectAll(".fuelcellline").data([overall]);

  gasLine.enter().append("path").attr("class","gasline").merge(gasLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  electricLine.enter().append("path").attr("class","electricline").merge(electricLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  plugInLine.enter().append("path").attr("class","pluginline").merge(plugInLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  fuelCellLine.enter().append("path").attr("class","fuelcellline").merge(fuelCellLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  overallLine.enter().append("path").attr("class","line").merge(overallLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));
}

function slide2() {
  // lines
  var overallLine = svg.selectAll(".line").data([overall]);
  var gasLine = svg.selectAll(".gasline").data([gas]);
  var electricLine = svg.selectAll(".electricline").data([electric]);
  var plugInLine = svg.selectAll(".pluginline").data([plugIn]);
  var fuelCellLine = svg.selectAll(".fuelcellline").data([fuelCell]);

  gasLine.enter().append("path").attr("class","gasline").merge(gasLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  electricLine.enter().append("path").attr("class","electricline").merge(electricLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  plugInLine.enter().append("path").attr("class","pluginline").merge(plugInLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  fuelCellLine.enter().append("path").attr("class","fuelcellline").merge(fuelCellLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));

  overallLine.enter().append("path").attr("class","line").merge(overallLine).transition().duration(3000)
    .attr("d", d3.line()
      .x(function(d) { return x(d.key); })
      .y(function(d) { return y(d.value.averageFE); })
      .curve(d3.curveMonotoneX));
}*/

function slide3() {

  /*svg.selectAll(".line").data([overall]).enter().append("circle").attr("class","line").merge(overallLine).transition().duration(3000)
    //.attr("d", d3.line()
    //  .x(function(d) { return x(d.key); })
    //  .y(function(d) { return y(d.value.averageFE); })
    //  .curve(d3.curveMonotoneX));
    //.attr("cx",
  svg.selectAll(".carmarks").data(data).enter().append("circle")
    .attr("cx", function(d) { return d.ModelYear; })
    .attr("cy", function(d) { var yr = d.ModelYear; return overall.filter(function(d) { return d.key === yr })[0].value.averageFE; })
    .attr("r", 6)
    .style("fill", "steelblue");
*/
}











    </script>
    <!--<script src="script.js"></script>-->
    <p><u>Sources</u><br>https://www.fueleconomy.gov/feg/download.shtml<br>https://www.ucsusa.org/resources/brief-history-us-fuel-efficiency<br>https://www.energy.gov/articles/history-electric-car</p>
  </body>

</html>